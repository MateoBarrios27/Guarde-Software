<div class="space-y-6 bg-gray-50 min-h-screen font-inter">
  
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-white rounded-xl shadow-lg">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Comunicaciones</h1>
      <p class="text-gray-600 mt-1">Gestiona los comunicados a tus clientes</p>
    </div>
    <button (click)="openModal('add')"
      class="mt-4 sm:mt-0 px-6 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg transition duration-200 flex items-center">
      <app-icon name="Plus" class="h-4 w-4 mr-2"></app-icon>
      Agregar Comunicado
    </button>
  </div>

  <div class="bg-white p-4 rounded-xl shadow-lg">
    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2 border-b pb-3">
      <app-icon name="Clock" class="h-5 w-5 text-blue-600"></app-icon>
      Comunicados Programados ({{ scheduledCommunications().length }})
    </h2>
    <div *ngIf="scheduledCommunications().length === 0" class="text-gray-500 text-center py-8">
      <p>No hay comunicados programados</p>
    </div>
    <div *ngIf="scheduledCommunications().length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      @for (comm of scheduledCommunications(); track comm.id) {
        <ng-container
          [ngTemplateOutlet]="communicationCardTemplate"
          [ngTemplateOutletContext]="{ communication: comm, isDraft: false, isPast: false }">
        </ng-container>
      }
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow-lg">
    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2 border-b pb-3">
      <app-icon name="FileText" class="h-5 w-5 text-gray-600"></app-icon>
      Comunicaciones Guardadas ({{ draftCommunications().length }})
    </h2>
    <div *ngIf="draftCommunications().length === 0" class="text-gray-500 text-center py-8">
      <p>No hay comunicaciones guardadas</p>
    </div>
    <div *ngIf="draftCommunications().length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      @for (comm of draftCommunications(); track comm.id) {
        <ng-container
          [ngTemplateOutlet]="communicationCardTemplate"
          [ngTemplateOutletContext]="{ communication: comm, isDraft: true, isPast: false }">
        </ng-container>
      }
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow-lg">
    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2 border-b pb-3">
      <app-icon name="MessageCircle" class="h-5 w-5 text-green-600"></app-icon>
      Comunicados Anteriores ({{ pastCommunications().length }})
    </h2>
    <div *ngIf="pastCommunications().length === 0" class="text-gray-500 text-center py-8">
      <p>No hay comunicados anteriores</p>
    </div>
    <div *ngIf="pastCommunications().length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      @for (comm of pastCommunications(); track comm.id) {
        <ng-container
          [ngTemplateOutlet]="communicationCardTemplate"
          [ngTemplateOutletContext]="{ communication: comm, isDraft: false, isPast: true }">
        </ng-container>
      }
    </div>
  </div>

  <div *ngIf="toast().show"
    class="fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white max-w-sm transition-opacity duration-300 z-50"
    [ngClass]="toast().color === 'success' ? 'bg-green-600' : 'bg-red-600'">
    <div class="flex items-center">
      <span class="text-2xl mr-3">{{ toast().icon }}</span>
      <div>
        <p class="font-bold">{{ toast().message }}</p>
        <p class="text-sm opacity-90">{{ toast().description }}</p>
      </div>
    </div>
  </div>
</div>

@if (currentModal() !== 'none') {
<div class="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm h-full w-full" (click)="closeModal()"></div>
<div
  class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 p-6 bg-white rounded-xl shadow-2xl w-[95%] max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all duration-300 ease-in-out">

  <div class="flex justify-between items-center border-b pb-3 mb-4">
    <h2 class="text-xl font-semibold text-gray-800">
      @switch (currentModal()) {
        @case ('add') { Agregar Nuevo Comunicado }
        @case ('edit') { Editar Comunicado }
        @case ('view') { Detalles del Comunicado }
        @case ('delete-confirm') { Confirmar Eliminaci√≥n }
        @case ('send-confirm') { Confirmar Env√≠o }
      }
    </h2>
    <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600">
      <app-icon name="x"></app-icon>
    </button>
  </div>

  @if (currentModal() === 'add' || currentModal() === 'edit') {
  <div class="space-y-4">
    
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo del comunicado *</label>
      <input type="text" [ngModel]="formData().title" 
             (ngModelChange)="updateFormField('title', $event)" placeholder="Ej: Aumento de tarifas 2024"
        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Canales de comunicaci√≥n *</label>
      <div class="flex flex-col sm:flex-row gap-4">
        @for (channel of channels; track channel.id) {
        <div 
          class="flex items-center space-x-2 p-3 bg-gray-50 border rounded-lg cursor-pointer hover:bg-gray-100 transition duration-150"
          (click)="toggleChannel(channel.name)">
          <input 
            type="checkbox" 
            [id]="'channel-' + channel.name" 
            [checked]="formData().channels.includes(channel.name)" 
            class="rounded text-blue-600 focus:ring-blue-500 pointer-events-none"/> 
          <label class="flex items-center gap-2 cursor-pointer text-sm font-medium text-gray-900">
            <app-icon [name]="channel.icon" [ngClass]="channel.name === 'Email' ? 'text-blue-600' : 'text-green-600'"></app-icon>
            <span>{{ channel.spanishLabel }}</span>
          </label>
        </div>
        }
      </div>
      <p *ngIf="formData().channels.length === 0" class="text-xs text-red-500 mt-2">Selecciona al menos un canal</p>
    </div>

    <div>
      <div class="flex justify-between items-center mb-1">
        <label class="block text-sm font-medium text-gray-700">Destinatarios *</label>
        <span class="text-xs text-blue-600 font-semibold" *ngIf="selectedCount() > 0">
          {{ selectedCount() }} clientes seleccionados
        </span>
      </div>
      
      <div (click)="openRecipientSelector()" 
           class="w-full p-3 border border-gray-300 rounded-lg cursor-pointer bg-white hover:bg-gray-50 transition flex justify-between items-center group">
          <div class="flex-1 overflow-hidden">
              <span *ngIf="selectedCount() === 0" class="text-gray-400 text-sm">Haz clic para seleccionar clientes...</span>
              <div *ngIf="selectedCount() > 0" class="flex flex-col">
                  <span class="font-medium text-gray-900 text-sm truncate">{{ selectedSummary() }}</span>
              </div>
          </div>
          <app-icon name="users" class="text-gray-400 group-hover:text-blue-600 transition h-5 w-5"></app-icon>
      </div>
      <p class="text-xs text-gray-500 mt-1">Puedes seleccionar grupos completos y excluir personas espec√≠ficas.</p>
    </div>

    <div class="space-y-4 pt-2 border-t border-dashed">
      
      <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 flex items-center justify-between">
        <div>
            <span class="block font-bold text-blue-900 text-sm">¬øEs un Estado de Cuenta?</span>
            <span class="block text-xs text-blue-600 mt-0.5">El contenido se generar√° autom√°ticamente con los saldos.</span>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" [ngModel]="formData().isAccountStatement" (ngModelChange)="updateFormField('isAccountStatement', $event)" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
        </label>
      </div>

      <div class="relative">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          {{ formData().isAccountStatement ? 'Contenido (Autom√°tico)' : 'Contenido *' }}
        </label>
        
        <div *ngIf="formData().isAccountStatement" 
             class="absolute inset-0 z-10 bg-white/60 backdrop-blur-[2px] flex items-center justify-center rounded-lg border border-gray-200 mt-6">
          <div class="bg-white px-4 py-2 rounded-lg shadow-sm border border-blue-100 flex items-center gap-2">
            <app-icon name="file-text" class="h-5 w-5 text-blue-600"></app-icon>
            <span class="text-sm font-medium text-gray-700">Contenido generado por sistema</span>
          </div>
        </div>

        <div [class.opacity-40]="formData().isAccountStatement">
          @if (formData().channels.includes('Email')) {
            <p *ngIf="formData().channels.includes('WhatsApp')" class="text-xs text-gray-500 mb-2">
              üí° Escribe el contenido del email. Se enviar√° una versi√≥n de solo texto a WhatsApp.
            </p>
            <quill-editor 
              [ngModel]="formData().content"
              (ngModelChange)="updateFormField('content', $event)"
              [styles]="{ 'height': '200px', 'display': 'block' }"
              placeholder="Escribe el contenido del email aqu√≠...">
            </quill-editor>
          } @else if (formData().channels.includes('WhatsApp')) {
            <p class="text-xs text-gray-500 mb-2">üí° Para WhatsApp: Mant√©n el mensaje breve y directo.</p>
            <textarea [ngModel]="formData().content" 
                  (ngModelChange)="updateFormField('content', $event)"
                  [rows]="8"
                  placeholder="Escribe el contenido para WhatsApp aqu√≠..."
                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-y"></textarea>
          } @else {
            <div class="w-full p-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-400 text-center h-32 flex items-center justify-center">
              <p>Selecciona un canal para escribir el contenido.</p>
            </div>
          }
        </div>
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Servidor de Env√≠o</label>
      <div class="relative">
        <select [ngModel]="formData().smtpConfigId" 
                (ngModelChange)="updateFormField('smtpConfigId', $event)"
                class="w-full p-2 pr-8 border border-gray-300 rounded-lg appearance-none bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option *ngFor="let smtp of smtpConfigs()" [ngValue]="smtp.id">{{ smtp.name }}</option>
        </select>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
          <app-icon name="chevron-down" class="h-4 w-4"></app-icon>
        </div>
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Archivos Adjuntos</label>
      <div class="flex items-center gap-4">
          <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-lg border border-gray-300 transition flex items-center shadow-sm">
              <app-icon name="file-plus" class="w-4 h-4 mr-2"></app-icon>
              Adjuntar Archivos
              <input type="file" multiple (change)="onFileSelected($event)" class="hidden">
          </label>
          <span class="text-xs text-gray-500">{{ selectedFiles().length }} archivos seleccionados</span>
      </div>
      <div *ngIf="selectedFiles().length > 0" class="mt-2 space-y-1">
          <div *ngFor="let file of selectedFiles(); let i = index" class="flex items-center justify-between text-sm bg-blue-50 p-2 rounded border border-blue-100">
              <span class="truncate max-w-[200px] text-blue-700">{{ file.name }}</span>
              <button (click)="removeFile(i)" class="text-red-500 hover:text-red-700 p-1 hover:bg-red-50 rounded">
                  <app-icon name="x" class="w-4 h-4"></app-icon>
              </button>
          </div>
      </div>
    </div>

    <div class="border-t pt-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">¬øCu√°ndo enviar?</label>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        
        <div class="flex items-center p-3 border rounded-lg cursor-pointer transition hover:bg-gray-50"
             [ngClass]="formData().type === 'enviar_ahora' ? 'bg-blue-50 border-blue-300 ring-1 ring-blue-300' : 'border-gray-200'"
             (click)="updateFormField('type', 'enviar_ahora')">
          <input type="radio" name="type" value="enviar_ahora" 
                 [ngModel]="formData().type" class="text-blue-600 pointer-events-none" />
          <div class="ml-2">
            <span class="block text-sm font-semibold text-gray-900">Ahora</span>
            <span class="block text-[10px] text-gray-500 leading-tight">Env√≠o inmediato</span>
          </div>
        </div>

        <div class="flex items-center p-3 border rounded-lg cursor-pointer transition hover:bg-gray-50"
             [ngClass]="formData().type === 'programar' ? 'bg-blue-50 border-blue-300 ring-1 ring-blue-300' : 'border-gray-200'"
             (click)="updateFormField('type', 'programar')">
          <input type="radio" name="type" value="programar" 
                 [ngModel]="formData().type" class="text-blue-600 pointer-events-none" />
          <div class="ml-2">
            <span class="block text-sm font-semibold text-gray-900">Programar</span>
            <span class="block text-[10px] text-gray-500 leading-tight">Elegir fecha</span>
          </div>
        </div>

        <div class="flex items-center p-3 border rounded-lg cursor-pointer transition hover:bg-gray-50"
             [ngClass]="formData().type === 'borrador' ? 'bg-gray-100 border-gray-400' : 'border-gray-200'"
             (click)="updateFormField('type', 'borrador')">
          <input type="radio" name="type" value="borrador" 
                 [ngModel]="formData().type" class="text-gray-600 pointer-events-none" />
          <div class="ml-2">
            <span class="block text-sm font-medium text-gray-700">Borrador</span>
            <span class="block text-[10px] text-gray-500 leading-tight">Guardar para despu√©s</span>
          </div>
        </div>

      </div>
    </div>

    @if (formData().type === 'programar') {
    <div class="grid grid-cols-2 gap-4 animate-fade-in bg-gray-50 p-3 rounded-lg border border-gray-200">
      <div>
        <label class="block text-xs font-medium text-gray-700 mb-1">Fecha de env√≠o</label>
        <input type="date" [ngModel]="formData().sendDate"
               (ngModelChange)="updateFormField('sendDate', $event)"
          class="w-full p-2 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" />
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-700 mb-1">Hora de env√≠o</label>
        <input type="time" [ngModel]="formData().sendTime"
               (ngModelChange)="updateFormField('sendTime', $event)"
          class="w-full p-2 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" />
      </div>
    </div>
    }

    <div class="flex gap-3 pt-2 mt-2">
      <button (click)="currentModal() === 'add' ? addCommunication() : editCommunication()" [disabled]="!isFormValid()"
        class="flex-1 px-4 py-3 rounded-lg text-white shadow-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed font-bold flex justify-center items-center gap-2"
        [ngClass]="isFormValid() ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400'">
        
        @switch (formData().type) {
          @case ('enviar_ahora') { <app-icon name="Send" class="h-4 w-4"></app-icon> Enviar Ahora }
          @case ('programar') { <app-icon name="Calendar" class="h-4 w-4"></app-icon> Programar Comunicado }
          @case ('borrador') { <app-icon name="save" class="h-4 w-4"></app-icon> Guardar Borrador }
        }
      </button>
      <button (click)="closeModal()"
        class="px-6 py-3 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition duration-200 font-medium">
        Cancelar
      </button>
    </div>
  </div>
  }

  @if (currentModal() === 'view' && selectedCommunication()) {
  <div class="space-y-4">
    <div class="p-4 rounded-lg space-y-3 border bg-gray-50">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-900">{{ selectedCommunication()!.title }}</h3>
        <span [ngClass]="getBadgeMeta(selectedCommunication()!.status).classes">
          <app-icon *ngIf="getBadgeMeta(selectedCommunication()!.status).icon"
            [name]="getBadgeMeta(selectedCommunication()!.status).icon!"></app-icon>
          <span class="ml-2">{{ getBadgeMeta(selectedCommunication()!.status).text }}</span>
        </span>
      </div>

      <div class="flex items-center gap-2 text-sm text-gray-600">
        <ng-container *ngFor="let ic of getChannelMeta(selectedCommunication()!.channel).icons">
          <app-icon [name]="ic.name" [ngClass]="ic.classes + ' h-4 w-4'" class="inline-block"></app-icon>
        </ng-container>
        <span>{{ selectedCommunication()!.channel }}</span>
      </div>

      <div class="border-t pt-3">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Contenido:</h4>
        <div 
          [innerHTML]="getSanitizedHtmlContent()"
          class="bg-white p-3 rounded border text-sm shadow-inner max-h-48 overflow-y-auto prose prose-sm max-w-none">
        </div>
      </div>

      <div class="border-t pt-3">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Destinatarios ({{ selectedCommunication()!.recipients.length }}):</h4>
        <div class="flex flex-wrap gap-1 max-h-32 overflow-y-auto">
          @for (dest of selectedCommunication()!.recipients; track dest) {
          <span class="inline-flex items-center text-xs font-medium bg-gray-200 text-gray-800 px-2.5 py-0.5 rounded-full">{{ dest }}</span>
          }
        </div>
      </div>
      
      @if (selectedCommunication()!.status === 'Scheduled' || selectedCommunication()!.status === 'Finished' || selectedCommunication()!.status === 'Finished w/ Errors') {
      <div class="border-t pt-3 text-sm text-gray-600">
        <strong>{{ selectedCommunication()!.status === 'Scheduled' ? 'Programado para' : 'Enviado el' }}:</strong>
        {{ selectedCommunication()!.sendDate | date: 'dd/MM/yyyy' }} a las {{ selectedCommunication()!.sendTime }}
      </div>
      }

      <div class="border-t pt-3 text-sm text-gray-600">
        <strong>Creado:</strong> {{ selectedCommunication()!.creationDate | date: 'dd/MM/yyyy' }}
      </div>
    </div>

    <button (click)="closeModal()"
      class="w-full px-4 py-2 rounded-full border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 transition duration-200">
      Cerrar
    </button>
  </div>
  }

  @if (currentModal() === 'delete-confirm' && selectedCommunication()) {
    <div class="space-y-6 text-center p-4">
      <div class="text-red-500 mx-auto text-5xl flex items-center justify-center h-16 w-16 bg-red-100 rounded-full">
        <app-icon name="Trash2"></app-icon>
      </div>
      <h3 class="text-xl font-bold text-gray-900">¬øEst√°s seguro?</h3>
      <p class="text-gray-600">
        Esta acci√≥n eliminar√° el comunicado "<strong>{{ selectedCommunication()!.title }}</strong>" de forma permanente.
      </p>
      <div class="flex gap-4">
        <button (click)="handleDeleteCommunication(selectedCommunication()!.id)" class="flex-1 flex justify-center items-center px-4 py-2 rounded-full bg-red-600 hover:bg-red-700 text-white shadow-md transition duration-200">
          Confirmar Eliminaci√≥n
        </button>
        <button (click)="closeModal()" class="flex-1 px-4 py-2 rounded-full border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 transition duration-200">
          Cancelar
        </button>
      </div>
    </div>
  }

  @if (currentModal() === 'send-confirm' && selectedCommunication()) {
  <div class="space-y-4">
    <div class="bg-blue-50 p-4 rounded-lg space-y-2 border border-blue-200">
      <h4 class="text-sm font-semibold text-gray-700">Resumen del comunicado:</h4>
      <p class="text-sm"><strong>T√≠tulo:</strong> {{ selectedCommunication()!.title }}</p>
      <p class="text-sm"><strong>Canal:</strong> {{ selectedCommunication()!.channel }}</p>
      <p class="text-sm"><strong>Destinatarios:</strong> {{ selectedCommunication()!.recipients.length }} destinatario(s)
      </p>
    </div>

    <div class="bg-yellow-50 p-3 rounded text-sm border border-yellow-200">
      <p class="text-yellow-800 font-medium flex items-center">
        <app-icon name="AlertTriangle" class="h-4 w-4 mr-2"></app-icon>
        <strong>Atenci√≥n:</strong>&nbsp;El comunicado se enviar√° <strong>&nbsp;inmediatamente</strong>.
      </p>
    </div>

    <div class="flex gap-2 pt-2">
      <button (click)="handleSendCommunication(selectedCommunication()!.id)"
        class="flex-1 px-4 py-2 rounded-full bg-green-600 hover:bg-green-700 text-white shadow-md transition duration-200 flex items-center justify-center">
        <app-icon name="Send" class="h-4 w-4 mr-2"></app-icon>
        Confirmar Env√≠o
      </button>
      <button (click)="closeModal()"
        class="flex-1 px-4 py-2 rounded-full border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 transition duration-200">
        Cancelar
      </button>
    </div>
  </div>
  }
</div>
}

<ng-template #communicationCardTemplate let-comm="communication" let-isDraft="isDraft" let-isPast="isPast">
  <div class="p-4 pb-2 bg-white rounded-xl border border-gray-200 shadow hover:shadow-lg transition-shadow duration-200 flex flex-col h-full">

    <div class="flex items-start justify-between">
      <h3 class="text-sm font-semibold text-gray-900 line-clamp-2 pr-4">{{ comm.title }}</h3>
      <span [ngClass]="getBadgeMeta(comm.status).classes">
        <app-icon *ngIf="getBadgeMeta(comm.status).icon" [name]="getBadgeMeta(comm.status).icon!" class="h-3 w-3"></app-icon>
        <span class="ml-1 text-xs">{{ getBadgeMeta(comm.status).text }}</span>
      </span>
    </div>

    <div class="space-y-3 mt-3 flex-grow">
      <p class="text-xs text-gray-600 line-clamp-2">
        {{ getCommunicationPreview(comm.content, comm.channel) }}
      </p>

      <div class="flex items-center gap-2 text-xs text-gray-500">
        <ng-container *ngFor="let ic of getChannelMeta(comm.channel).icons">
          <app-icon [name]="ic.name" [ngClass]="ic.classes + ' h-3 w-3'" class="inline-block"></app-icon>
        </ng-container>
        <span>{{ comm.channel }}</span>
        <span>‚Ä¢</span>
        @if (isDraft) {
        <span>Creado: {{ comm.creationDate | date: 'dd/MM/yyyy'}}</span>
        } @else {
        <app-icon name="Calendar" class="h-3 w-3"></app-icon>
        <span>
          {{ comm.sendDate | date: 'dd/MM/yyyy' }} {{ comm.sendTime }}
        </span>
        }
      </div>

      <div class="flex items-center gap-1 text-xs text-gray-500">
        <app-icon name="user" class="h-3 w-3"></app-icon>
        <span>{{ comm.recipients.length }} destinatario(s)</span>
      </div>
    </div>

    <div class="flex gap-1 pt-2 border-t mt-3">
      <button (click)="openModal('view', comm)" title="Ver detalles"
        class="flex-1 flex justify-center items-center p-2 rounded-full text-gray-600 hover:bg-gray-100 transition">
        <app-icon name="eye" class="h-4 w-4"></app-icon>
      </button>

      @if (comm.status === 'Draft' || comm.status === 'Scheduled') {
      <button (click)="openModal('edit', comm)" title="Editar comunicado"
        class="flex-1 flex justify-center items-center p-2 rounded-full text-blue-600 hover:bg-blue-100 transition">
        <app-icon name="edit" class="h-4 w-4"></app-icon>
      </button>
      }

      @if (comm.status === 'Draft') {
      <button (click)="openModal('send-confirm', comm)" title="Enviar ahora"
        class="flex-1 flex justify-center items-center p-2 rounded-full text-green-600 hover:bg-green-100 transition">
        <app-icon name="Send" class="h-4 w-4"></app-icon>
      </button>
      } 
      
      @else if (comm.status === 'Failed' || comm.status === 'Finished w/ Errors') {
      <button (click)="openRetryModal(comm)" 
              title="Editar y Reintentar Fallidos"
              class="flex-1 flex justify-center items-center p-2 rounded-full text-orange-600 hover:bg-orange-100 transition">
        <app-icon name="RefreshCw" class="h-4 w-4"></app-icon>
      </button>
      }
      
      @else if (comm.status === 'Finished') {
        <button (click)="openModal('add', comm, true)" 
                title="Reutilizar / Clonar comunicado"
                class="flex-1 flex justify-center items-center p-2 rounded-full text-blue-600 hover:bg-blue-100 transition">
          <app-icon name="RefreshCw" class="h-4 w-4"></app-icon>
        </button>
      }

      @if (comm.status !== 'Processing') {
      <button (click)="openModal('delete-confirm', comm)" title="Eliminar comunicado"
        class="flex-1 flex justify-center items-center p-2 rounded-full text-red-600 hover:bg-red-100 transition">
        <app-icon name="Trash2" class="h-4 w-4"></app-icon>
      </button>
      }
    </div>
  </div>
</ng-template>

@if (showRecipientModal()) {
<div class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden animate-fade-in">
        
        <div class="bg-gray-900 text-white p-4 flex justify-between items-center shrink-0">
            <div>
                <h2 class="text-xl font-bold">Seleccionar Destinatarios</h2>
                <p class="text-gray-400 text-sm">Usa los filtros para selecci√≥n masiva o selecciona individualmente.</p>
            </div>
            <button (click)="showRecipientModal.set(false)" class="text-gray-400 hover:text-white transition p-2 rounded-full hover:bg-white/10">
                <app-icon name="x" class="h-6 w-6"></app-icon>
            </button>
        </div>

        <div class="flex flex-1 overflow-hidden">
            
            <div class="w-64 bg-gray-50 border-r border-gray-200 p-4 flex flex-col gap-3 shrink-0">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Selecci√≥n R√°pida</h3>
                
                <button (click)="applyFilter('Todos')" class="selector-btn border-blue-200 hover:bg-blue-50 text-blue-700">
                    <div class="w-8 h-8 rounded bg-blue-100 flex items-center justify-center text-blue-600 mr-3">
                        <app-icon name="users" class="h-4 w-4"></app-icon>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-sm">Todos</div>
                    </div>
                </button>

                <button (click)="applyFilter('Morosos')" class="selector-btn border-red-200 hover:bg-red-50 text-red-700">
                    <div class="w-8 h-8 rounded bg-red-100 flex items-center justify-center text-red-600 mr-3">
                        <app-icon name="alert-triangle" class="h-4 w-4"></app-icon>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-sm">Morosos</div>
                    </div>
                </button>

                <button (click)="applyFilter('Pendientes')" class="selector-btn border-orange-200 hover:bg-orange-50 text-orange-700">
                    <div class="w-8 h-8 rounded bg-orange-100 flex items-center justify-center text-orange-600 mr-3">
                        <app-icon name="clock" class="h-4 w-4"></app-icon>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-sm">Pendientes</div>
                    </div>
                </button>

                <button (click)="applyFilter('AlDia')" class="selector-btn border-green-200 hover:bg-green-50 text-green-700">
                    <div class="w-8 h-8 rounded bg-green-100 flex items-center justify-center text-green-600 mr-3">
                        <app-icon name="check-circle" class="h-4 w-4"></app-icon>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-sm">Al D√≠a</div>
                    </div>
                </button>

                <div class="h-px bg-gray-200 my-2"></div>

                <button (click)="applyFilter('Ninguno')" class="flex items-center justify-center w-full py-2 text-sm text-gray-500 hover:bg-gray-200 rounded transition">
                    Desmarcar todo
                </button>
            </div>

            <div class="flex-1 flex flex-col bg-white">
                <div class="p-3 border-b border-gray-100 sticky top-0 bg-white z-10 flex gap-3">            
                    <div class="relative flex-1">
                        <app-icon name="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 h-4 w-4"></app-icon>
                        <input type="text" 
                               [ngModel]="recipientSearchTerm()"
                               (ngModelChange)="onSearch($event)"
                               placeholder="Buscar cliente por nombre o email..." 
                               class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white transition">
                    </div>

                    <button (click)="toggleSort()" 
                            class="flex items-center gap-2 px-3 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition text-sm font-medium text-gray-700 min-w-[140px] justify-center"
                            [title]="currentSort() === 'name' ? 'Cambiar a orden por Estado' : 'Cambiar a orden Alfab√©tico'">
                        <app-icon name="list" class="h-4 w-4 text-gray-500"></app-icon>
                        <span *ngIf="currentSort() === 'name'">Por Nombre</span>
                        <span *ngIf="currentSort() === 'status'">Por Estado</span>
                        <app-icon name="arrow-down" class="h-3 w-3 text-gray-400"></app-icon>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-2">
                    <div *ngIf="filteredClients().length === 0" class="flex flex-col items-center justify-center h-full text-gray-400">
                        <app-icon name="search" class="h-10 w-10 mb-2 opacity-50"></app-icon>
                        <p>No se encontraron resultados.</p>
                    </div>

                    <div class="grid grid-cols-1 gap-1">
                        <div *ngFor="let client of filteredClients()" 
                             (click)="toggleSelection(client.id)"
                             class="flex items-center p-2 rounded-lg border cursor-pointer transition select-none group"
                             [ngClass]="client.selected ? 'bg-blue-50 border-blue-200 shadow-sm' : 'bg-white border-transparent hover:bg-gray-50'">
                            
                            <div class="mr-3 flex items-center justify-center h-6 w-6 rounded border transition-colors"
                                 [ngClass]="client.selected ? 'bg-blue-600 border-blue-600' : 'border-gray-300 bg-white'">
                                <app-icon *ngIf="client.selected" name="check" class="h-4 w-4 text-white"></app-icon>
                            </div>

                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <span class="font-medium text-gray-900 truncate">{{ client.fullName }}</span>
                                    
                                    <span class="text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wide"
                                          [ngClass]="{
                                            'bg-red-100 text-red-700': client.status === 'Moroso',
                                            'bg-orange-100 text-orange-700': client.status === 'Pendiente',
                                            'bg-green-100 text-green-700': client.status === 'AlDia'
                                          }">
                                        {{ client.status }}
                                    </span>
                                </div>
                                <div class="flex items-center gap-3 text-xs text-gray-500 mt-0.5">
                                    <span>{{ client.email || 'Sin email' }}</span>
                                    <span *ngIf="client.balance > 0" class="text-red-600 font-medium">Deuda: ${{ client.balance | number }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-2 border-t bg-gray-50 text-xs text-gray-500 flex justify-between px-4">
                    <span>Mostrando {{ filteredClients().length }} de {{ allClients().length }}</span>
                    <span>{{ selectedCount() }} seleccionados</span>
                </div>
            </div>
        </div>

        <div class="p-4 border-t bg-white flex justify-end gap-3 shrink-0">
            <button (click)="showRecipientModal.set(false)" class="px-5 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition">
                Cancelar
            </button>
            <button (click)="confirmSelection()" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-md transition flex items-center gap-2">
                <app-icon name="check" class="h-4 w-4"></app-icon>
                Confirmar Selecci√≥n ({{ selectedCount() }})
            </button>
        </div>
    </div>
</div>
}