<div
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm"
>
  <form
    [formGroup]="newClientForm"
    (ngSubmit)="onSubmit()"
    (click)="$event.stopPropagation()"
    class="flex flex-col max-h-[90vh] w-full max-w-7xl bg-gradient-to-br from-gray-50 to-blue-50 rounded-lg shadow-2xl"
  >
    <!-- Header -->
    <header
      class="flex-shrink-0 relative bg-gradient-to-r from-blue-600 via-blue-700 to-purple-700 text-white p-4"
    >
      <button
        type="button"
        (click)="closeModal.emit()"
        class="absolute top-3 right-3 p-2 text-white rounded-full hover:bg-white/20"
      >
        <app-icon name="x" class="h-5 w-5"></app-icon>
      </button>
      <div class="flex items-center gap-3">
        <div
          class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center"
        >
          <app-icon [name]="isEditMode ? 'edit' : 'user-plus'" class="h-6 w-6 text-white"></app-icon>
        </div>
        <div>
          <h2 class="text-2xl font-bold">{{ isEditMode ? 'Editar Cliente' : 'Nuevo Cliente' }}</h2>
          <p class="text-blue-100 text-sm">
            {{ isEditMode ? 'Actualiza la información del cliente.' : 'Registra un nuevo cliente en el sistema' }}
          </p>
        </div>
      </div>
    </header>

    <!-- Contenido Principal -->
    <main class="flex-1 overflow-y-auto p-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        
        <!-- COL 1: INFO PERSONAL -->
        <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-md border">
          <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-t-lg">
            <h3 class="flex items-center gap-2 font-semibold text-base">
              <app-icon name="users" class="h-5 w-5"></app-icon>Información Personal y Fiscal
            </h3>
          </div>
          <div class="p-4 space-y-4">
            <div>
              <label class="text-sm font-medium text-blue-700">Número de Identificación</label>
              <input formControlName="numeroIdentificacion" placeholder="Ej: 0.14" class="w-full mt-1 p-2 border rounded-md"/>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div><label class="text-sm font-medium text-blue-700">Nombre *</label><input formControlName="nombre" class="w-full mt-1 p-2 border rounded-md"/></div>
              <div><label class="text-sm font-medium text-blue-700">Apellido *</label><input formControlName="apellido" class="w-full mt-1 p-2 border rounded-md"/></div>
            </div>
            <div class="col-span-2">
              <label class="text-sm font-medium text-blue-700">Nº Doc. (DNI) *</label>
              <input formControlName="numeroDocumento" class="w-full mt-1 p-2 border rounded-md"/>
            </div>
            <div>
              <label class="text-sm font-medium text-blue-700">CUIT</label>
              <input formControlName="cuit" placeholder="Opcional" class="w-full mt-1 p-2 border rounded-md"/>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-blue-700">Condición IVA *</label>
                  <select formControlName="condicionIVA" class="w-full mt-1 p-2 border rounded-md bg-white">
                    <option [ngValue]="null" disabled>Seleccionar...</option>
                    <option value="Consumidor Final">Consumidor Final</option>
                    <option value="Monotributista">Monotributista</option>
                    <option value="Responsable Inscripto">Responsable Inscripto</option>
                    <option value="Exento">Exento</option>
                  </select>
                </div>
                <div>
                  <label class="text-sm font-medium text-blue-700">Tipo Factura *</label>
                  <select formControlName="billingTypeId" class="w-full mt-1 p-2 border rounded-md bg-white">
                    <option [ngValue]="null" disabled>Seleccionar...</option>
                    <option *ngFor="let bt of billingTypes" [value]="bt.id">{{ bt.name }}</option>
                  </select>
                </div>
            </div>
            <div>
              <label class="text-sm font-medium text-blue-700">Método de Pago *</label>
              <select formControlName="metodoPago" class="w-full mt-1 p-2 border rounded-md bg-white">
                <option [ngValue]="null" disabled>Seleccionar método</option>
                <option *ngFor="let method of paymentMethods" [ngValue]="method">{{ method.name }}</option>
              </select>
            </div>
          </div>
        </div>

        <!-- COL 2: CONTACTO -->
        <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-md border">
          <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-t-lg">
            <h3 class="flex items-center gap-2 font-semibold text-base">
              <app-icon name="envelope" class="h-5 w-5"></app-icon>Contacto y Ubicación
            </h3>
          </div>
          <div class="p-4 space-y-4">
            <div formArrayName="emails">
              <label class="text-sm font-medium text-green-700">Emails *</label>
              <div *ngFor="let email of emails.controls; let i = index" class="flex gap-2 mt-1">
                <input [formControlName]="i" class="w-full p-2 border rounded-md"/>
                <button *ngIf="emails.length > 1" type="button" (click)="removeEmail(i)" class="p-1 text-red-500">
                  <app-icon name="x" class="h-4 w-4"></app-icon>
                </button>
              </div>
              <button type="button" (click)="addEmail()" class="text-sm text-blue-600 mt-2 font-semibold">+ Agregar Email</button>
            </div>
            <div formArrayName="telefonos">
              <label class="text-sm font-medium text-green-700">Teléfonos</label>

              <div
                *ngFor="let tel of telefonos.controls; let i = index"
                [formGroupName]="i"
                class="flex items-center gap-2 mt-2"
              >
                <!-- INPUT CON ICONO ADENTRO -->
                <div class="relative flex-1">
                  <input
                    formControlName="number"

                    class="w-full pr-10 p-2 border rounded-md focus:outline-none"
                    [ngClass]="
                      tel.get('whatsapp')?.value
                        ? 'border-green-400 focus:ring-1 focus:ring-green-400'
                        : 'border-gray-300'
                    "
                  />

                  <!-- ICONO WHATSAPP -->
                  <button
                    type="button"
                    (click)="tel.get('whatsapp')?.setValue(!tel.get('whatsapp')?.value)"
                    class="absolute right-2 top-1/2 -translate-y-1/2
                          flex items-center justify-center
                          h-6 w-6 text-gray-400 transition"
                    [ngClass]="
                      tel.get('whatsapp')?.value
                        ? 'text-green-500'
                        : 'hover:text-green-400'
                    "
                    title="WhatsApp"
                  >
                    <app-icon name="whatsapp" class="h-5 w-5"></app-icon>
                  </button>

                </div>

                <!-- BOTÓN ELIMINAR -->
                <button
                  *ngIf="telefonos.length > 1"
                  type="button"
                  (click)="removeTelefono(i)"
                  class="h-10 w-10 flex items-center justify-center
                        border border-red-400 text-red-500 rounded-md
                        hover:bg-red-50"
                >
                  <app-icon name="x" class="h-4 w-4"></app-icon>
                </button>

              </div>

              <!-- AGREGAR -->
              <button
                type="button"
                (click)="addTelefono()"
                class="mt-3 inline-flex items-center gap-2 px-4 py-2 border border-green-400 text-green-600 rounded-md hover:bg-green-50 text-sm font-medium"
              >
                <app-icon name="plus" class="h-4 w-4"></app-icon>
                Agregar Teléfono
              </button>
            </div>


            <div><label class="text-sm font-medium text-green-700">Dirección *</label><input formControlName="direccion" class="w-full mt-1 p-2 border rounded-md"/></div>
            <div class="grid grid-cols-2 gap-4">
              <div><label class="text-sm font-medium text-green-700">Ciudad *</label><input formControlName="ciudad" class="w-full mt-1 p-2 border rounded-md"/></div>
              <div><label class="text-sm font-medium text-green-700">Provincia *</label><input formControlName="provincia" class="w-full mt-1 p-2 border rounded-md"/></div>
            </div>
          </div>
        </div>

        <!-- COL 3: LEGACY Y OBSERVACIONES -->
        <div class="space-y-4">
          <!-- Tarjeta Legacy -->
          <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-md border">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-t-lg">
              <h3 class="flex items-center gap-2 font-semibold text-base"><app-icon name="user-gear" class="h-5 w-5"></app-icon>Información de Ingreso</h3>
            </div>
            <fieldset [disabled]="isEditMode" [class.opacity-60]="isEditMode">
              <div class="p-4 space-y-4">
                <label for="legacy-toggle" class="flex items-center justify-between" [class.cursor-not-allowed]="isEditMode" [class.cursor-pointer]="!isEditMode">
                  <div class="flex flex-col"><span class="font-medium text-gray-700">¿Es un cliente antiguo?</span><span class="text-sm text-gray-500">Activa esto para ingresar datos manualmente.</span></div>
                  <div class="relative"><input type="checkbox" id="legacy-toggle" class="sr-only" formControlName="isLegacyClient"><div class="block w-10 h-6 rounded-full transition" [ngClass]="newClientForm.value.isLegacyClient ? 'bg-purple-600' : 'bg-gray-300'"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition" [ngClass]="{ 'translate-x-full': newClientForm.value.isLegacyClient }"></div></div>
                </label>
                
                <div *ngIf="isEditMode" class="text-xs text-center text-purple-700 font-medium -mt-2">(La información de ingreso no se puede editar)</div>

                <div *ngIf="newClientForm.value.isLegacyClient; else newClientBlock" class="pt-4 border-t border-dashed space-y-4 animate-fade-in">
                    <div class="grid grid-cols-2 gap-4">
                      <div><label class="text-sm font-medium text-purple-700">Fecha de Ingreso *</label><input type="date" formControlName="legacyStartDate" class="w-full mt-1 p-2 border rounded-md"/></div>
                      <div><label class="text-sm font-medium text-purple-700">Monto Inicial *</label><input type="number" formControlName="legacyInitialAmount" placeholder="0.00" class="w-full mt-1 p-2 border rounded-md"/></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <div><label class="text-sm font-medium text-purple-700">Próx. Aumento *</label><input type="month" formControlName="legacyNextIncreaseDate" class="w-full mt-1 p-2 border rounded-md"/></div>
                      <div><label class="text-sm font-medium text-purple-700">Meses Prepagos</label><input type="number" formControlName="prepaidMonths" placeholder="0" min="0" class="w-full mt-1 p-2 border rounded-md"/></div>
                    </div>
                    <label for="promo-toggle" class="flex items-center cursor-pointer space-x-3 pt-2" [class.cursor-not-allowed]="isEditMode"><input type="checkbox" id="promo-toggle" formControlName="isLegacy6MonthPromo" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"><div class="flex flex-col"><span class="font-medium text-gray-700">Promoción 6 Meses</span><span class="text-sm text-gray-500">Marcar si este cliente tiene aumentos cada 6 meses.</span></div></label>
                </div>
                <ng-template #newClientBlock><div class="pt-4 border-t border-dashed"><div class="text-center py-4 text-gray-500 bg-gray-50 rounded-lg"><p class="font-medium text-gray-600">Es un cliente nuevo</p><p class="text-sm">Se usará la fecha de hoy como inicio y se aplicará el 1er débito.</p></div></div></ng-template>
              </div>
            </fieldset>
          </div>
          <!-- Tarjeta Observaciones -->
          <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-md border">
             <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-t-lg"><h3 class="flex items-center gap-2 font-semibold text-base"><app-icon name="file-text" class="h-5 w-5"></app-icon>Observaciones</h3></div>
             <div class="p-4"><label class="text-sm font-medium text-orange-700">Notas del cliente</label><textarea formControlName="observaciones" rows="3" class="w-full p-2 border rounded-md mt-1"></textarea></div>
          </div>
        </div>

        <!-- ============================================== -->
        <!-- === SECCIÓN 5: ESPACIOS / LOCKERS (UNIFICADA) === -->
        <!-- ============================================== -->
        <div class="lg:col-span-3">
          
          <!-- ESTA ES LA TARJETA ÚNICA QUE ENVUELVE TODO -->
          <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-md border">
            
            <!-- Header Único -->
            <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white p-4 rounded-t-lg">
              <h3 class="flex items-center gap-2 font-semibold text-base">
                <app-icon name="package" class="h-5 w-5"></app-icon>
                {{ isEditMode ? 'Asignación de Lockers' : 'Selección de Espacios' }}
              </h3>
            </div>
            
            <!-- Grid de 2 Columnas Interno -->
            <!-- Aquí aplicamos grid-cols-2 para que SIEMPRE estén lado a lado en pantallas grandes -->
            <div class="p-4 grid grid-cols-1 lg:grid-cols-2 gap-6">
              
              <!-- ============================================= -->
              <!-- COLUMNA IZQUIERDA (INPUTS) -->
              <!-- ============================================= -->
              <div class="space-y-4">
                
                <!-- MODO CREACIÓN: Tarjetas de Solicitud -->
                <ng-container *ngIf="!isEditMode">
                  <div formArrayName="spaceRequests" class="space-y-4 max-h-[40vh] lg:max-h-none lg:overflow-y-auto pr-2">
                    
                    <div *ngFor="let request of spaceRequests.controls; let i = index" 
                         [formGroupName]="i" 
                         class="p-4 border-2 border-gray-200 rounded-lg bg-white relative shadow-sm">
                      
                      <!-- Botón X sutil DENTRO de la tarjeta -->
                      <button type="button" 
                              (click)="removeSpaceRequest(i)"
                              class="absolute top-2 right-2 p-1 text-gray-400 hover:text-red-500 transition-colors"
                              title="Eliminar espacio">
                        <app-icon name="x" class="h-4 w-4"></app-icon>
                      </button>

                      <div class="flex flex-col sm:flex-row sm:items-end gap-3 mt-2">
                          <div class="flex-1">
                              <label class="block text-sm font-medium text-indigo-700 mb-1">Depósito *</label>
                              <!-- Usamos [ngValue]="w.id" para mantener el tipo numérico -->
                              <select formControlName="warehouseId" class="w-full p-2 border rounded-md bg-white text-sm">
                                <option [ngValue]="null" disabled>Seleccionar...</option>
                                <option *ngFor="let w of warehouses" [ngValue]="w.id">{{ w.name }}</option>
                              </select>
                          </div>
                          <div class="w-full sm:w-28">
                              <label class="block text-sm font-medium text-indigo-700 mb-1">Metros (m³) *</label>
                              <input type="number" min="0.1" step="1" formControlName="m3" class="w-full p-2 border rounded-md text-sm"/>
                          </div>
                          <div class="flex items-center gap-1.5 pt-4 sm:pt-0 sm:pb-0.5">
                              <button type="button" (click)="updateQuantity(i, -1)" class="px-2 py-1 h-9 w-9 border rounded-md bg-gray-200 hover:bg-gray-300 font-bold text-lg text-gray-700">-</button>
                              <input type="number" formControlName="quantity" readonly class="w-10 h-9 p-2 border rounded-md text-center font-medium bg-gray-50"/>
                              <button type="button" (click)="updateQuantity(i, 1)" class="px-2 py-1 h-9 w-9 border rounded-md bg-gray-200 hover:bg-gray-300 font-bold text-lg text-gray-700">+</button>
                          </div>
                      </div>
                    </div>
                  </div>
                  <button type="button" (click)="addSpaceRequest()" class="w-full flex items-center justify-center p-4 border-2 border-dashed border-indigo-300 text-indigo-600 font-medium rounded-lg hover:bg-indigo-50 transition-all">
                    <app-icon name="plus" class="h-8 w-8"></app-icon>
                  </button>
                </ng-container>

                <!-- MODO EDICIÓN: Lista de Lockers Físicos -->
                <ng-container *ngIf="isEditMode">
                    <!-- ... (El contenido de edición se mantiene igual) ... -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      <div class="relative sm:col-span-2">
                        <app-icon name="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 h-4 w-4"></app-icon>
                        <input formControlName="lockerSearch" placeholder="Buscar por identificador..." class="pl-10 w-full p-2 border rounded-md"/>
                      </div>
                      <select formControlName="selectedWarehouse" class="p-2 border rounded-md bg-white"><option value="all">Todos los depósitos</option><option *ngFor="let wh of warehouses" [value]="wh.id">{{ wh.name }}</option></select>
                      <select formControlName="selectedLockerType" class="p-2 border rounded-md bg-white"><option value="all">Todos los tipos</option><option *ngFor="let type of lockerTypes" [value]="type.id">{{ type.name }}</option></select>
                    </div>
                    <div class="max-h-80 overflow-y-auto space-y-2 border rounded-md p-2 bg-gray-50/50">
                      <p *ngIf="filteredLockers.length === 0" class="text-center py-8 text-gray-500">No se encontraron lockers disponibles.</p>
                      <div *ngFor="let locker of filteredLockers"
                           (click)="handleLockerToggle(locker.id)"
                           [ngClass]="{ 'bg-indigo-50 border-indigo-300 ring-2 ring-indigo-200': newClientForm.get('lockersAsignados')?.value.includes(locker.id) }"
                           class="p-3 rounded-lg border bg-white cursor-pointer hover:border-indigo-300">
                        <div class="flex items-start space-x-3">
                          <input type="checkbox" [checked]="newClientForm.get('lockersAsignados')?.value.includes(locker.id)" readonly class="mt-1 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"/>
                          <div class="flex-1">
                            <div class="flex justify-between items-center mb-1">
                              <span class="font-medium text-indigo-900">{{ locker.identifier }}</span>
                              <!-- <span *ngIf="getLockerDetails(locker.id).lockerType" class="text-green-600 font-semibold text-sm">${{ getLockerDetails(locker.id).lockerType?.amount | number : "1.0-0" }}</span> -->
                            </div>
                            <div class="flex items-center gap-4 text-sm text-gray-600">
                              <span *ngIf="getLockerDetails(locker.id).warehouse">{{ getLockerDetails(locker.id).warehouse?.name }}</span>
                              <span *ngIf="getLockerDetails(locker.id).lockerType">{{ getLockerDetails(locker.id).lockerType?.name }}</span>
                              <span *ngIf="getLockerDetails(locker.id).lockerType">{{ getLockerDetails(locker.id).lockerType?.m3 }}m³</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                </ng-container>

              </div> 
              <!-- FIN COLUMNA IZQUIERDA -->

              <!-- ============================================= -->
              <!-- COLUMNA DERECHA: Resumen de Costos (COMÚN) -->
              <!-- ============================================= -->
              <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg p-4 border border-indigo-200 h-fit sticky top-4">
                <h4 class="font-medium text-indigo-900 mb-3 flex items-center gap-2">
                  <app-icon name="dollar-sign" class="h-4 w-4"></app-icon>Resumen de Costos
                </h4>
                
                <div class="space-y-2 overflow-y-auto border-t border-b py-2">
                  
                  <!-- Items Modo Creación -->
                  <ng-container *ngIf="!isEditMode">
                    <ng-container *ngIf="spaceRequests.value.length > 0 && (spaceRequests.value[0].warehouseId || spaceRequests.value[0].m3); else noRequestsCreation">
                      <div *ngFor="let req of spaceRequests.value" class="flex justify-between items-center p-2 bg-white/50 rounded">
                        <div>
                          <div class="font-medium text-sm text-indigo-900">{{ req.quantity || 0 }} {{ req.quantity === 1 ? 'espacio' : 'espacios' }} de {{ req.m3 || 0 }} m³</div>
                          <div class="text-xs text-gray-600">en {{ getWarehouseName(req.warehouseId) || '?' }}</div>
                        </div>
                      </div>
                    </ng-container>
                    <ng-template #noRequestsCreation>
                       <div class="text-center py-8 text-gray-500"><p class="font-medium">Sin espacios solicitados</p><p class="text-sm">Añada espacios a la izquierda.</p></div>
                    </ng-template>
                  </ng-container>

                  <!-- Items Modo Edición -->
                  <ng-container *ngIf="isEditMode">
                    <ng-container *ngIf="newClientForm.value.lockersAsignados?.length > 0; else noLockersEdit">
                      <div *ngFor="let lockerId of newClientForm.value.lockersAsignados" class="flex justify-between items-center p-2 bg-white/50 rounded">
                        <ng-container *ngIf="getLockerDetails(lockerId) as details">
                          <div>
                            <div class="font-medium text-sm text-indigo-900">{{ details.locker?.identifier || 'ID: '+ lockerId }}</div>
                            <div class="text-xs text-gray-600">{{ details.warehouse?.name || '?' }} • {{ details.lockerType?.name || '?' }}</div>
                          </div>
                          <!-- <div class="text-green-600 font-semibold text-sm">${{ (details.lockerType?.amount | number : "1.0-0") || '0' }}</div> -->
                        </ng-container>
                      </div>
                    </ng-container>
                    <ng-template #noLockersEdit>
                       <div class="text-center py-8 text-gray-500"><p class="font-medium">Ningún locker seleccionado</p><p class="text-sm">Selecciona lockers de la lista.</p></div>
                    </ng-template>
                  </ng-container>

                </div>
                
                <!-- Monto y M3 -->
                <div class="pt-3">
                  <!-- ... (Monto Manual) ... -->
                  <div class="flex justify-between items-center mb-2">
                    <label for="montoManual" class="font-semibold text-indigo-900">Subtotal Mensual:</label>
                    <div class="relative">
                       <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                       <input id="montoManual" type="number" formControlName="montoManual" class="w-32 text-right pl-6 pr-2 py-1 border rounded-md text-lg font-bold text-green-600"/>
                    </div>
                  </div>
                  <div class="text-xs text-gray-600 space-y-1">
                    <div class="flex justify-between">
                      <span>Total m³ contratados:</span>
                      <span>{{ newClientForm.value.contractedM3 | number:'1.1-2' }} m³</span>
                    </div>
                  </div>
                  <!-- Nuevo campo Espacios Ocupados -->
                   <div class="flex justify-between items-center mt-2 pt-2 border-t border-indigo-100">
                    <label for="occupiedSpaces" class="text-sm font-semibold text-indigo-900">Espacios Ocupados:</label>
                    <input id="occupiedSpaces" type="number" formControlName="occupiedSpaces" min="0" class="w-20 text-center p-1 border rounded-md text-gray-700"/>
                  </div>
                </div>
              </div> <!-- Fin Columna Derecha -->

            </div> <!-- Fin Grid -->
          </div> <!-- Fin Tarjeta Unificada -->
        </div> <!-- Fin lg:col-span-3 -->

      </div>
    </main>

    <!-- Footer -->
    <footer class="flex-shrink-0 p-4 flex justify-end gap-4 bg-gray-50 border-t">
      <button type="button" (click)="closeModal.emit()" class="px-4 py-2 text-sm font-semibold text-gray-700 bg-white border rounded-lg hover:bg-gray-100">Cancelar</button>
      <button type="submit" [disabled]="newClientForm.invalid || isLoading" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2">
        <app-icon *ngIf="isLoading" name="loader" class="h-4 w-4 animate-spin"></app-icon>
        {{ isLoading ? 'Guardando...' : (isEditMode ? 'Guardar Cambios' : 'Guardar Cliente') }}
      </button>
    </footer>
  </form>
</div>