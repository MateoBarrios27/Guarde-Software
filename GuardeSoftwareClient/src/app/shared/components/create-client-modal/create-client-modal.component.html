<div
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm"
  (click)="closeModal.emit()"
>
  <form
    [formGroup]="newClientForm"
    (ngSubmit)="onSubmit()"
    (click)="$event.stopPropagation()"
    class="flex flex-col max-h-[90vh] w-full max-w-7xl bg-gradient-to-br from-gray-50 to-blue-50 rounded-lg shadow-2xl"
  >
    <header
      class="flex-shrink-0 relative bg-gradient-to-r from-blue-600 via-blue-700 to-purple-700 text-white p-4"
    >
      <button
        type="button"
        (click)="closeModal.emit()"
        class="absolute top-3 right-3 p-2 text-white rounded-full hover:bg-white/20"
      >
        <app-icon name="x" class="h-5 w-5"></app-icon>
      </button>
      <div class="flex items-center gap-3">
        <div
          class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center"
        >
          <!-- Icono cambia si estamos editando -->
          <app-icon [name]="clientData ? 'edit' : 'user-plus'" class="h-6 w-6 text-white"></app-icon>
        </div>
        <div>
          <!-- Títle changes if it's editting -->
          <h2 class="text-2xl font-bold">{{ clientData ? 'Editar Cliente' : 'Nuevo Cliente' }}</h2>
          <p class="text-blue-100 text-sm">
            {{ clientData ? 'Actualiza la información del cliente.' : 'Registra un nuevo cliente en el sistema' }}
          </p>
        </div>
      </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        
        <!-- ============================ -->
      <!-- TARJETA INFORMACIÓN PERSONAL (MODIFICADA) -->
      <!-- ============================ -->
      <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-md border">
        <div
          class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-t-lg"
        >
          <h3 class="flex items-center gap-2 font-semibold text-base">
            <app-icon name="users" class="h-5 w-5"></app-icon>Información
            Personal y Fiscal
          </h3>
        </div>
        <div class="p-4 space-y-4">
          
          <!-- Número de Identificación (Sin cambios) -->
          <div>
            <label class="text-sm font-medium text-blue-700"
              >Número de Identificación</label
            >
            <input
              formControlName="numeroIdentificacion"
              placeholder="Ej: 0.14 (Se auto-genera si se deja vacío)"
              class="w-full mt-1 p-2 border rounded-md"
            />
          </div>

          <!-- Nombre y Apellido (Sin cambios) -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium text-blue-700">Nombre *</label
              ><input
                formControlName="nombre"
                class="w-full mt-1 p-2 border rounded-md"
              />
            </div>
            <div>
              <label class="text-sm font-medium text-blue-700"
                >Apellido *</label
              ><input
                formControlName="apellido"
                class="w-full mt-1 p-2 border rounded-md"
              />
            </div>
          </div>

          <!-- DNI (Nº Doc) -->
          <div class="grid grid-cols-2 gap-4">
            <!-- CAMPO OCULTO: Tipo Doc -->
            <div *ngIf="false">
              <label class="text-sm font-medium text-blue-700"
                >Tipo Doc. *</label
              ><select
                formControlName="tipoDocumento"
                class="w-full mt-1 p-2 border rounded-md bg-white"
              >
                <option>DNI</option>
                <option>CUIT</option>
              </select>
            </div>
            <!-- Campo DNI ocupa todo -->
            <div class="col-span-2">
              <label class="text-sm font-medium text-blue-700"
                >Nº Doc. (DNI) *</label
              ><input
                formControlName="numeroDocumento"
                class="w-full mt-1 p-2 border rounded-md"
              />
            </div>
          </div>

          <!-- CUIT (Sin cambios) -->
          <div>
            <label class="text-sm font-medium text-blue-700"
              >CUIT</label
            >
            <input
              formControlName="cuit"
              placeholder="Opcional"
              class="w-full mt-1 p-2 border rounded-md"
            />
          </div>

          <!-- Condición IVA y Tipo Factura -->
          <div class="grid grid-cols-2 gap-4">
              <!-- === CAMBIO AQUÍ: Opciones de Condición IVA añadidas === -->
              <div>
                <label class="text-sm font-medium text-blue-700"
                  >Condición IVA *</label
                ><select
                  formControlName="condicionIVA"
                  class="w-full mt-1 p-2 border rounded-md bg-white"
                >
                  <option [ngValue]="null" disabled>Seleccionar...</option>
                  <option value="Consumidor Final">Consumidor Final</option>
                  <option value="Monotributista">Monotributista</option>
                  <option value="Responsable Inscripto">Responsable Inscripto</option>
                  <option value="Exento">Exento</option>
                </select>
              </div>

              <!-- === CAMBIO AQUÍ: 'documento' reemplazado por 'billingType' === -->
              <div>
                <label class="text-sm font-medium text-blue-700"
                  >Tipo Factura *</label
                >
                <select
                  formControlName="billingTypeId"
                  class="w-full mt-1 p-2 border rounded-md bg-white"
                >
                  <option [ngValue]="null" disabled>Seleccionar...</option>
                  <option *ngFor="let bt of billingTypes" [value]="bt.id">
                    {{ bt.name }}
                  </option>
                </select>
              </div>
          </div>
          
          <!-- Método de Pago (Sin cambios) -->
          <div>
            <label class="text-sm font-medium text-blue-700">Método de Pago *</label>
            <select
              formControlName="metodoPago"
              class="w-full mt-1 p-2 border rounded-md bg-white"
            >
              <option [ngValue]="null" disabled>Seleccionar método</option>
              <option *ngFor="let method of paymentMethods" [ngValue]="method">
                {{ method.name }}
              </option>
            </select>
          </div>
          
          <!-- CAMPO OCULTO: 'documento' ya no se usa, lo dejamos por si acaso -->
          <div *ngIf="false">
             <select formControlName="documento">
               <option value="SF">Sin Factura</option>
             </select>
          </div>

        </div>
      </div>

        <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-md border">
          <div
            class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-t-lg"
          >
            <h3 class="flex items-center gap-2 font-semibold text-base">
              <app-icon name="envelope" class="h-5 w-5"></app-icon>Contacto y
              Ubicación
            </h3>
          </div>
          <div class="p-4 space-y-4">
            <div formArrayName="emails">
              <label class="text-sm font-medium text-green-700">Emails *</label>
              <div
                *ngFor="let email of emails.controls; let i = index"
                class="flex gap-2 mt-1"
              >
                <input
                  [formControlName]="i"
                  class="w-full p-2 border rounded-md"
                /><button
                  *ngIf="emails.length > 1"
                  type="button"
                  (click)="removeEmail(i)"
                  class="p-1 text-red-500"
                >
                  <app-icon name="x" class="h-4 w-4"></app-icon>
                </button>
              </div>
              <button
                type="button"
                (click)="addEmail()"
                class="text-sm text-blue-600 mt-2 font-semibold"
              >
                + Agregar Email
              </button>
            </div>
            <div formArrayName="telefonos">
              <label class="text-sm font-medium text-green-700"
                >Teléfonos</label
              >
              <div
                *ngFor="let tel of telefonos.controls; let i = index"
                class="flex gap-2 mt-1"
              >
                <input
                  [formControlName]="i"
                  placeholder="+54 11 1234-5678"
                  class="w-full p-2 border rounded-md"
                />
                <button
                  *ngIf="telefonos.length > 1"
                  type="button"
                  (click)="removeTelefono(i)"
                  class="p-1 text-red-500"
                >
                  <app-icon name="x" class="h-4 w-4"></app-icon>
                </button>
              </div>
              <button
                type="button"
                (click)="addTelefono()"
                class="text-sm text-blue-600 mt-2 font-semibold"
              >
                + Agregar Teléfono
              </button>
            </div>
            <div>
              <label class="text-sm font-medium text-green-700"
                >Dirección *</label
              ><input
                formControlName="direccion"
                class="w-full mt-1 p-2 border rounded-md"
              />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-sm font-medium text-green-700"
                  >Ciudad *</label
                ><input
                  formControlName="ciudad"
                  class="w-full mt-1 p-2 border rounded-md"
                />
              </div>
              <div>
                <label class="text-sm font-medium text-green-700"
                  >Provincia *</label
                ><input
                  formControlName="provincia"
                  class="w-full mt-1 p-2 border rounded-md"
                />
              </div>
            </div>
          </div>
        </div>

        <div class="space-y-4">
          <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-md border">
            <div
              class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-t-lg"
            >
              <h3 class="flex items-center gap-2 font-semibold text-base">
                <app-icon name="user-gear" class="h-5 w-5"></app-icon>
                Información de Ingreso
              </h3>
            </div>
            
            <!-- 
              Usamos <fieldset> para deshabilitar toda la sección
              - [disabled]="clientData" deshabilita si estamos en modo Edición
            -->
            <fieldset [disabled]="clientData" [class.opacity-60]="clientData">
              <div class="p-4 space-y-4">
                
                <!-- Interruptor (Toggle) Cliente Antiguo -->
                <label for="legacy-toggle" class="flex items-center justify-between cursor-pointer" [class.cursor-not-allowed]="clientData">
                  <div class="flex flex-col">
                      <span class="font-medium text-gray-700">¿Es un cliente antiguo?</span>
                      <span class="text-sm text-gray-500">Activa esto para ingresar datos manualmente.</span>
                  </div>
                  <div class="relative">
                    <input type="checkbox" id="legacy-toggle" class="sr-only" formControlName="isLegacyClient">
                    <div class="block w-10 h-6 rounded-full transition" [ngClass]="newClientForm.value.isLegacyClient ? 'bg-purple-600' : 'bg-gray-300'"></div>
                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition" [ngClass]="{ 'translate-x-full': newClientForm.value.isLegacyClient }"></div>
                  </div>
                </label>
                <div *ngIf="clientData" class="text-xs text-center text-purple-700 font-medium -mt-2">
                  (La información de ingreso no se puede editar)
                </div>

                <!-- Contenido Condicional (Si es Legacy) -->
                <div *ngIf="newClientForm.value.isLegacyClient; else newClientBlock" class="pt-4 border-t border-dashed space-y-4 animate-fade-in">
                    
                    <!-- CAMPOS AÑADIDOS -->
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                          <label class="text-sm font-medium text-purple-700">Fecha de Ingreso *</label>
                          <input
                            type="date"
                            formControlName="legacyStartDate"
                            class="w-full mt-1 p-2 border rounded-md"
                          />
                      </div>
                      <div>
                          <label class="text-sm font-medium text-purple-700">Monto Inicial *</label>
                          <input
                            type="number"
                            formControlName="legacyInitialAmount"
                            placeholder="0.00"
                            class="w-full mt-1 p-2 border rounded-md"
                          />
                      </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                      <div>
                          <label class="text-sm font-medium text-purple-700">Próx. Aumento *</label>
                          <input
                            type="date"
                            formControlName="legacyNextIncreaseDate"
                            class="w-full mt-1 p-2 border rounded-md"
                          />
                      </div>
                      <div>
                          <label class="text-sm font-medium text-purple-700">Meses Prepagos</label>
                          <input
                            type="number"
                            formControlName="prepaidMonths"
                            placeholder="0"
                            class="w-full mt-1 p-2 border rounded-md"
                          />
                      </div>
                    </div>
                    
                    <label for="promo-toggle" class="flex items-center cursor-pointer space-x-3 pt-2" [class.cursor-not-allowed]="clientData">
                      <input type="checkbox" id="promo-toggle" 
                             formControlName="isLegacy6MonthPromo"
                             class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                      <div class="flex flex-col">
                          <span class="font-medium text-gray-700">Promoción 6 Meses</span>
                          <span class="text-sm text-gray-500">Marcar si este cliente tiene aumentos cada 6 meses.</span>
                      </div>
                    </label>
                </div>

                <!-- Template para cliente nuevo -->
                <ng-template #newClientBlock>
                    <div class="pt-4 border-t border-dashed">
                        <div class="text-center py-4 text-gray-500 bg-gray-50 rounded-lg">
                            <p class="font-medium text-gray-600">Es un cliente nuevo</p>
                            <p class="text-sm">Se usará la fecha de hoy como inicio.</p>
                        </div>
                    </div>
                </ng-template>
              </div>
            </fieldset> <!-- Fin del fieldset deshabilitador -->
          </div>
          <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-md border">
            <div
              class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-t-lg"
            >
              <h3 class="flex items-center gap-2 font-semibold text-base">
                <app-icon name="file-text" class="h-5 w-5"></app-icon
                >Observaciones
              </h3>
            </div>
            <div class="p-4">
              <label class="text-sm font-medium text-orange-700"
                >Notas del cliente</label
              >
              <textarea
                formControlName="observaciones"
                rows="3"
                class="w-full p-2 border rounded-md"
              ></textarea>
            </div>
          </div>
        </div>

        <div class="lg:col-span-3">
          <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-md border">
            <div
              class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white p-4 rounded-t-lg"
            >
              <h3 class="flex items-center gap-2 font-semibold text-base">
                <app-icon name="package" class="h-5 w-5"></app-icon>Selección de
                Lockers
              </h3>
            </div>
            <div class="p-4 grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div class="relative sm:col-span-2">
                    <app-icon
                      name="search"
                      class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 h-4 w-4"
                    ></app-icon
                    ><input
                      formControlName="lockerSearch"
                      placeholder="Buscar por identificador..."
                      class="pl-10 w-full p-2 border rounded-md"
                    />
                  </div>
                  <select
                    formControlName="selectedWarehouse"
                    class="p-2 border rounded-md bg-white"
                  >
                    <option value="all">Todos los depósitos</option>
                    <option *ngFor="let wh of warehouses" [value]="wh.id">
                      {{ wh.name }}
                    </option>
                  </select>
                  <select
                    formControlName="selectedLockerType"
                    class="p-2 border rounded-md bg-white"
                  >
                    <option value="all">Todos los tipos</option>
                    <option *ngFor="let type of lockerTypes" [value]="type.id">
                      {{ type.name }}
                    </option>
                  </select>
                </div>
                <div
                  class="max-h-80 overflow-y-auto space-y-2 border rounded-md p-2 bg-gray-50/50"
                >
                  <p
                    *ngIf="filteredLockers.length === 0"
                    class="text-center py-8 text-gray-500"
                  >
                    No se encontraron lockers disponibles.
                  </p>
                  <div
                    *ngFor="let locker of filteredLockers"
                    (click)="handleLockerToggle(locker.id)"
                    [ngClass]="{
                      'bg-indigo-50 border-indigo-300 ring-2 ring-indigo-200':
                        newClientForm.value.lockersAsignados.includes(locker.id)
                    }"
                    class="p-3 rounded-lg border bg-white cursor-pointer hover:border-indigo-300"
                  >
                    <div class="flex items-start space-x-3">
                      <input
                        type="checkbox"
                        [checked]="
                          newClientForm.value.lockersAsignados.includes(
                            locker.id
                          )
                        "
                        readonly
                        class="mt-1 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                      />
                      <div class="flex-1">
                        <div class="flex justify-between items-center mb-1">
                          <span class="font-medium text-indigo-900">{{
                            locker.identifier
                          }}</span
                          ><span
                            *ngIf="getLockerDetails(locker.id).lockerType"
                            class="text-green-600 font-semibold text-sm"
                            >${{
                              getLockerDetails(locker.id).lockerType?.amount
                                | number : "1.0-0"
                            }}</span
                          >
                        </div>
                        <div
                          class="flex items-center gap-4 text-sm text-gray-600"
                        >
                          <span
                            *ngIf="getLockerDetails(locker.id).warehouse"
                            class="flex items-center gap-1"
                            ><app-icon
                              name="building"
                              class="h-3 w-3"
                            ></app-icon
                            >{{
                              getLockerDetails(locker.id).warehouse?.name
                            }}</span
                          ><span
                            *ngIf="getLockerDetails(locker.id).lockerType"
                            >{{
                              getLockerDetails(locker.id).lockerType?.name
                            }}</span
                          ><span *ngIf="getLockerDetails(locker.id).lockerType"
                            >{{
                              getLockerDetails(locker.id).lockerType?.m3
                            }}m³</span
                          >
                        </div>
                        <p
                          *ngIf="locker.features"
                          class="text-xs text-gray-500 mt-1"
                        >
                          {{ locker.features }}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

             <div
              class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg p-4 border border-indigo-200"
            >
              <h4
                class="font-medium text-indigo-900 mb-3 flex items-center gap-2"
              >
                <app-icon name="dollar-sign" class="h-4 w-4"></app-icon>
                Resumen de Costos
              </h4>

              <div
                *ngIf="!newClientForm.value.lockersAsignados || newClientForm.value.lockersAsignados.length === 0"
                class="text-center py-8 text-gray-500"
              >
                  <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                       <app-icon name="package" class="h-8 w-8 text-gray-300"></app-icon>
                   </div>
                   <p class="font-medium">Ningún locker seleccionado</p>
                   <p class="text-sm">Selecciona lockers para ver el resumen</p>
              </div>

              <div
                *ngIf="newClientForm.value.lockersAsignados?.length > 0"
                class="space-y-3"
              >
                <div class="text-sm font-semibold text-indigo-700 mb-2">
                  {{ newClientForm.value.lockersAsignados.length }} locker(s)
                  seleccionado(s)
                </div>

                <div
                  class="space-y-2 max-h-52 overflow-y-auto border-t border-b py-2"
                >
                  <div
                    *ngFor="let lockerId of newClientForm.value.lockersAsignados"
                    class="flex justify-between items-center p-2 bg-white/50 rounded"
                  >
                    <ng-container *ngIf="getLockerDetails(lockerId) as details">
                        <div>
                            <div class="font-medium text-sm text-indigo-900">
                                {{ details.locker?.identifier || 'ID: '+ lockerId }}
                            </div>
                            <div class="text-xs text-gray-600">
                                {{ details.warehouse?.name || '?' }} •
                                {{ details.lockerType?.name || '?' }}
                            </div>
                        </div>
                        <div class="text-green-600 font-semibold text-sm">
                            ${{ (details.lockerType?.amount | number : "1.0-0") || '0' }}
                        </div>
                    </ng-container>
                    <ng-container *ngIf="!getLockerDetails(lockerId)">
                        <div class="text-xs text-red-500">Error al cargar datos del locker ID: {{ lockerId }}</div>
                    </ng-container>
                  </div>
                </div>
                <div class="pt-3">
                  <div class="flex justify-between items-center mb-2">
                    <label
                      for="montoManual"
                      class="font-semibold text-indigo-900"
                      >Subtotal Mensual:</label
                    >
                    <div class="relative">
                       <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                         <input
                           id="montoManual"
                           type="number"
                           formControlName="montoManual"
                           class="w-32 text-right pl-6 pr-2 py-1 border rounded-md text-lg font-bold text-green-600"
                         />
                    </div>
                  </div>
                  <div class="text-xs text-gray-600 space-y-1">
                    <div class="flex justify-between">
                       <span>Total m³ contratados:</span>
                       <span>{{ costSummary.totalM3 }} m³</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer
      class="flex-shrink-0 p-4 flex justify-end gap-4 bg-gray-50 border-t"
    >
      <button
        type="button"
        (click)="closeModal.emit()"
        class="px-4 py-2 text-sm font-semibold text-gray-700 bg-white border rounded-lg hover:bg-gray-100"
      >
        Cancelar
      </button>
      <button
        type="submit"
        [disabled]="newClientForm.invalid"
        class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50"
      >
        Guardar Cliente
      </button>
    </footer>
  </form>
</div>
